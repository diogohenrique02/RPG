<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Web App - História Dinâmica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #1a2530;
            --success: #27ae60;
            --warning: #f39c12;
            --fantasy: #9b59b6;
            --master: #d35400;
            --forest: #27ae60;
            --dungeon: #8e44ad;
            --castle: #e74c3c;
            --ocean: #3498db;
            --volcano: #e74c3c;
            --jungle: #1abc9c;
        }

        body {
            background-color: #1a1a2e;
            color: var(--light);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: linear-gradient(to right, var(--primary), var(--dark));
            padding: 20px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo i {
            color: var(--accent);
            font-size: 2.2rem;
        }

        .logo h1 {
            font-size: 2rem;
            background: linear-gradient(to right, var(--secondary), var(--fantasy));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .tagline {
            color: #bdc3c7;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .music-control {
            background-color: rgba(0, 0, 0, 0.3);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }

        .music-control:hover {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .tabs {
            display: flex;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            margin-top: 15px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background-color: transparent;
            border: none;
            color: #bdc3c7;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .tab:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .tab.active {
            background-color: var(--secondary);
            color: white;
        }

        .tab-content {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 30px;
        }

        .panel {
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            flex: 1;
            min-width: 300px;
        }

        .panel h2 {
            color: var(--secondary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .master-panel h2 {
            color: var(--master);
            border-bottom: 2px solid var(--master);
        }

        .panel h2 i {
            color: var(--accent);
        }

        .master-panel h2 i {
            color: var(--master);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #bdc3c7;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            padding-right: 45px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        select option {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            margin-top: 10px;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-danger {
            background-color: var(--accent);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-fantasy {
            background-color: var(--fantasy);
        }

        .btn-master {
            background-color: var(--master);
        }

        .btn-master:hover {
            background-color: #a84300;
        }

        .btn-forest {
            background-color: var(--forest);
        }

        .btn-dungeon {
            background-color: var(--dungeon);
        }

        .btn-castle {
            background-color: var(--castle);
        }

        .btn-ocean {
            background-color: var(--ocean);
        }

        .btn-volcano {
            background-color: var(--volcano);
        }

        .btn-jungle {
            background-color: var(--jungle);
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .characters-container, .campaigns-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .character-card, .campaign-card {
            background: linear-gradient(to bottom right, rgba(44, 62, 80, 0.9), rgba(26, 37, 48, 0.9));
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-left: 5px solid var(--secondary);
            transition: transform 0.3s;
            position: relative;
        }

        .campaign-card {
            border-left: 5px solid var(--fantasy);
        }

        .character-card:hover, .campaign-card:hover {
            transform: translateY(-5px);
        }

        .character-card h3, .campaign-card h3 {
            color: var(--secondary);
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .campaign-card h3 {
            color: var(--fantasy);
        }

        .character-class, .campaign-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .character-class {
            background-color: var(--accent);
            color: white;
        }

        .campaign-status {
            background-color: var(--fantasy);
            color: white;
        }

        .campaign-status.aguardando {
            background-color: var(--warning);
        }

        .campaign-status.configurando {
            background-color: var(--warning);
        }

        .campaign-status.andamento {
            background-color: var(--success);
        }

        .character-stats, .campaign-info {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .stat, .info-item {
            text-align: center;
        }

        .stat-value {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary);
        }

        .character-actions, .campaign-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .edit-btn {
            background-color: var(--warning);
            color: var(--dark);
        }

        .delete-btn {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .join-btn {
            background-color: var(--success);
            color: white;
        }

        .master-btn {
            background-color: var(--master);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
            grid-column: 1 / -1;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        /* MODAIS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal {
            background-color: var(--dark);
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--secondary);
        }

        .master-modal .modal-header {
            border-bottom: 2px solid var(--master);
        }

        .modal-header h2 {
            color: var(--secondary);
            margin: 0;
        }

        .master-modal .modal-header h2 {
            color: var(--master);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        /* JOGO ONLINE */
        .game-area {
            display: none;
            margin-top: 30px;
        }

        .game-area.active {
            display: block;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--fantasy);
        }

        .game-title h2 {
            color: var(--fantasy);
            margin-bottom: 5px;
        }

        .game-master {
            color: #bdc3c7;
            font-style: italic;
        }

        .game-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        /* SISTEMA DE HISTÓRIA DINÂMICA */
        .story-container {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 5px solid var(--fantasy);
            position: relative;
            min-height: 300px;
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .story-title {
            color: var(--fantasy);
            font-size: 1.4rem;
            font-weight: bold;
        }

        .story-progress {
            background-color: var(--fantasy);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .story-text {
            color: var(--light);
            line-height: 1.8;
            font-size: 1.1rem;
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 3px solid var(--secondary);
            min-height: 150px;
        }

        .story-choices {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .story-choice {
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 2px solid transparent;
        }

        .story-choice:hover {
            background-color: #2980b9;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-color: var(--light);
        }

        .story-choice:disabled {
            background-color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            border-color: transparent;
        }

        .choice-text {
            font-size: 1rem;
        }

        .choice-consequence {
            font-size: 0.85rem;
            opacity: 0.8;
            font-style: italic;
        }

        .choice-aggressive {
            background-color: var(--accent);
        }

        .choice-aggressive:hover {
            background-color: #c0392b;
        }

        .choice-diplomatic {
            background-color: var(--success);
        }

        .choice-diplomatic:hover {
            background-color: #219653;
        }

        .choice-stealth {
            background-color: var(--dungeon);
        }

        .choice-stealth:hover {
            background-color: #7d3c98;
        }

        .choice-magic {
            background-color: var(--fantasy);
        }

        .choice-magic:hover {
            background-color: #8e44ad;
        }

        /* HISTÓRICO DA HISTÓRIA */
        .story-history {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .story-history h4 {
            color: var(--secondary);
            margin-bottom: 10px;
        }

        .history-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: #bdc3c7;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-choice {
            color: var(--secondary);
            font-weight: bold;
        }

        .history-result {
            color: #bdc3c7;
            font-style: italic;
        }

        /* CHAT */
        .game-chat {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding-right: 10px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .message-player {
            color: var(--secondary);
        }

        .message-master {
            color: var(--master);
        }

        .message-system {
            color: var(--warning);
        }

        .message-text {
            color: var(--light);
        }

        .message-time {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-align: right;
            margin-top: 5px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            margin-top: 0;
        }

        .chat-input button {
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 0 20px;
            cursor: pointer;
            font-weight: 600;
        }

        /* JOGADORES E DADOS */
        .game-players {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .players-list {
            margin-top: 15px;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .player-info h4 {
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .player-info p {
            font-size: 0.9rem;
            color: #bdc3c8;
        }

        /* PAINEL DO MESTRE */
        .master-dashboard {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid var(--master);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .dashboard-card {
            background: linear-gradient(to bottom right, rgba(211, 84, 0, 0.2), rgba(26, 37, 48, 0.2));
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(211, 84, 0, 0.3);
        }

        .dashboard-card h4 {
            color: var(--master);
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--warning);
        }

        .player-stats {
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* DICE ROLLER */
        .dice-roller {
            margin-top: 30px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .dice-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }

        .dice-controls select, .dice-controls input {
            margin-top: 0;
        }

        .dice-result {
            margin-top: 20px;
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--warning);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* HISTÓRIAS DISPONÍVEIS */
        .story-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .story-option {
            background: linear-gradient(to bottom right, rgba(52, 152, 219, 0.2), rgba(155, 89, 182, 0.2));
            border-radius: 10px;
            padding: 20px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .story-option:hover {
            transform: translateY(-5px);
            border-color: var(--fantasy);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .story-option.selected {
            border-color: var(--success);
            background: linear-gradient(to bottom right, rgba(39, 174, 96, 0.2), rgba(155, 89, 182, 0.2));
        }

        .story-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--fantasy);
        }

        .story-meta {
            font-size: 0.8rem;
            color: #bdc3c7;
            margin-top: 10px;
        }

        /* GAME TYPES */
        .game-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .game-type-card {
            background: linear-gradient(to bottom right, rgba(44, 62, 80, 0.9), rgba(26, 37, 48, 0.9));
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            border-left: 5px solid var(--forest);
            transition: transform 0.3s;
        }

        .game-type-card:hover {
            transform: translateY(-5px);
        }

        .game-type-card.dungeon {
            border-left-color: var(--dungeon);
        }

        .game-type-card.castle {
            border-left-color: var(--castle);
        }

        .game-type-card.ocean {
            border-left-color: var(--ocean);
        }

        .game-type-card.volcano {
            border-left-color: var(--volcano);
        }

        .game-type-card.jungle {
            border-left-color: var(--jungle);
        }

        .game-type-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--forest);
        }

        .game-type-card.dungeon .game-type-icon {
            color: var(--dungeon);
        }

        .game-type-card.castle .game-type-icon {
            color: var(--castle);
        }

        .game-type-card.ocean .game-type-icon {
            color: var(--ocean);
        }

        .game-type-card.volcano .game-type-icon {
            color: var(--volcano);
        }

        .game-type-card.jungle .game-type-icon {
            color: var(--jungle);
        }

        /* COMPARTILHAMENTO */
        .share-container {
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
        }

        .share-code {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .share-code input {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        .share-code button {
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--success);
            color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.error {
            background-color: var(--accent);
        }

        .notification.warning {
            background-color: var(--warning);
        }

        /* ÁUDIO CONTROLS */
        .audio-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .audio-btn {
            background-color: var(--fantasy);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .audio-btn:hover {
            transform: scale(1.1);
            background-color: #8e44ad;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .volume-slider {
            width: 80px;
            height: 5px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--fantasy);
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--fantasy);
            cursor: pointer;
            border: none;
        }

        /* RESPONSIVIDADE */
        @media (max-width: 1024px) {
            .game-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                min-width: 50%;
            }
            
            .story-choices {
                grid-template-columns: 1fr;
            }
            
            .audio-controls {
                bottom: 10px;
                left: 10px;
                padding: 8px 12px;
            }
            
            .volume-slider {
                width: 60px;
            }
            
            .game-types {
                grid-template-columns: 1fr;
            }
            
            .story-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Áudio para música de RPG - VERSÃO FUNCIONANDO -->
    <audio id="rpgMusic" loop preload="auto">
        <source src="https://assets.mixkit.co/music/preview/mixkit-epic-quest-699.mp3" type="audio/mpeg">
        <source src="https://assets.mixkit.co/music/preview/mixkit-adventure-4-983.mp3" type="audio/mpeg">
        Seu navegador não suporta o elemento de áudio.
    </audio>

    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-dragon"></i>
                <h1>RPG Web App</h1>
            </div>
            <p class="tagline">
                Jogue RPG com amigos diretamente no navegador - sem downloads!
                <button class="music-control" id="headerMusicToggle">
                    <i class="fas fa-music"></i> <span id="musicStatus">Música: Clique para ativar</span>
                </button>
            </p>
            
            <div class="tabs">
                <button class="tab active" data-tab="characters">Personagens</button>
                <button class="tab" data-tab="campaigns">Campanhas</button>
                <button class="tab" data-tab="master">Painel do Mestre</button>
                <button class="tab" data-tab="game">Jogo Online</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- ABA 1: PERSONAGENS -->
        <div id="characters" class="tab-content active">
            <div class="main-content">
                <div class="panel">
                    <h2><i class="fas fa-user-plus"></i> Criar Personagem</h2>
                    <form id="characterForm">
                        <div class="form-group">
                            <label for="name">Nome do Personagem</label>
                            <input type="text" id="name" placeholder="Ex: Aragorn, Geralt, etc." required>
                        </div>
                        
                        <div class="form-group">
                            <label for="class">Classe</label>
                            <select id="class" required>
                                <option value="" disabled selected>Selecione uma classe</option>
                                <option value="Guerreiro">Guerreiro</option>
                                <option value="Mago">Mago</option>
                                <option value="Ladino">Ladino</option>
                                <option value="Clérigo">Clérigo</option>
                                <option value="Bárbaro">Bárbaro</option>
                                <option value="Bardo">Bardo</option>
                                <option value="Druida">Druida</option>
                                <option value="Paladino">Paladino</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="race">Raça</label>
                            <select id="race" required>
                                <option value="" disabled selected>Selecione uma raça</option>
                                <option value="Humano">Humano</option>
                                <option value="Elfo">Elfo</option>
                                <option value="Anão">Anão</option>
                                <option value="Halfling">Halfling</option>
                                <option value="Orc">Orc</option>
                                <option value="Draconato">Draconato</option>
                                <option value="Tiefling">Tiefling</option>
                                <option value="Gnomo">Gnomo</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="level">Nível</label>
                            <input type="number" id="level" min="1" max="20" value="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Atributos</label>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <label for="strength">Força</label>
                                    <input type="number" id="strength" min="1" max="20" value="10" required>
                                </div>
                                <div class="stat-item">
                                    <label for="dexterity">Destreza</label>
                                    <input type="number" id="dexterity" min="1" max="20" value="10" required>
                                </div>
                                <div class="stat-item">
                                    <label for="constitution">Constituição</label>
                                    <input type="number" id="constitution" min="1" max="20" value="10" required>
                                </div>
                                <div class="stat-item">
                                    <label for="intelligence">Inteligência</label>
                                    <input type="number" id="intelligence" min="1" max="20" value="10" required>
                                </div>
                                <div class="stat-item">
                                    <label for="wisdom">Sabedoria</label>
                                    <input type="number" id="wisdom" min="1" max="20" value="10" required>
                                </div>
                                <div class="stat-item">
                                    <label for="charisma">Carisma</label>
                                    <input type="number" id="charisma" min="1" max="20" value="10" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="background">História/Background</label>
                            <textarea id="background" rows="4" placeholder="Conte a história do seu personagem..."></textarea>
                        </div>
                        
                        <input type="hidden" id="characterId" value="">
                        
                        <button type="submit" id="saveBtn" class="btn btn-success">
                            <i class="fas fa-save"></i> Salvar Personagem
                        </button>
                        
                        <button type="button" id="clearBtn" class="btn btn-danger">
                            <i class="fas fa-times"></i> Limpar Formulário
                        </button>
                    </form>
                </div>
                
                <div class="panel">
                    <h2><i class="fas fa-users"></i> Personagens Salvos</h2>
                    <div id="charactersList" class="characters-container">
                        <!-- Personagens serão carregados aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA 2: CAMPANHAS -->
        <div id="campaigns" class="tab-content">
            <div class="main-content">
                <div class="panel">
                    <h2><i class="fas fa-book"></i> Criar Campanha</h2>
                    <form id="campaignForm">
                        <div class="form-group">
                            <label for="campaignName">Nome da Campanha</label>
                            <input type="text" id="campaignName" placeholder="Ex: A Maldição de Strahd" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="campaignType">Tipo de Aventura</label>
                            <select id="campaignType" required>
                                <option value="" disabled selected>Selecione o tipo de aventura</option>
                                <option value="Fantasia Épica">Fantasia Épica</option>
                                <option value="Mistério Sobrenatural">Mistério Sobrenatural</option>
                                <option value="Aventura Subterrânea">Aventura Subterrânea</option>
                                <option value="Guerra de Reinos">Guerra de Reinos</option>
                                <option value="Viagem no Tempo">Viagem no Tempo</option>
                                <option value="Invasão Alienígena">Invasão Alienígena</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="campaignMaster">Quem será o Mestre?</label>
                            <select id="campaignMaster" required>
                                <option value="" disabled selected>Selecione o mestre</option>
                                <option value="Eu">Eu serei o mestre</option>
                                <option value="Sistema">Sistema (Mestre Automático)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="maxPlayers">Número Máximo de Jogadores</label>
                            <input type="number" id="maxPlayers" min="2" max="8" value="4" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="campaignDescription">Descrição da Campanha</label>
                            <textarea id="campaignDescription" rows="4" placeholder="Descreva o tom, ambiente e regras especiais da campanha..."></textarea>
                        </div>
                        
                        <input type="hidden" id="campaignId" value="">
                        
                        <button type="submit" id="saveCampaignBtn" class="btn btn-fantasy">
                            <i class="fas fa-plus-circle"></i> Criar Campanha
                        </button>
                        
                        <button type="button" id="clearCampaignBtn" class="btn btn-danger">
                            <i class="fas fa-times"></i> Limpar
                        </button>
                    </form>
                </div>
                
                <div class="panel">
                    <h2><i class="fas fa-dungeon"></i> Campanhas Disponíveis</h2>
                    <div id="campaignsList" class="campaigns-container">
                        <!-- Campanhas serão carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA 3: PAINEL DO MESTRE -->
        <div id="master" class="tab-content">
            <div class="main-content">
                <div class="panel master-panel">
                    <h2><i class="fas fa-crown"></i> Painel do Mestre</h2>
                    
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h4>Jogadores Ativos</h4>
                            <div class="stat-number" id="activePlayersCount">0</div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h4>Campanhas Ativas</h4>
                            <div class="stat-number" id="activeCampaignsCount">0</div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h4>Personagens Criados</h4>
                            <div class="stat-number" id="totalCharactersCount">0</div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h4>Dados Rolados</h4>
                            <div class="stat-number" id="diceRolledCount">0</div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <h3><i class="fas fa-eye"></i> Monitoramento em Tempo Real</h3>
                        <div class="player-stats" id="masterPlayerStats">
                            <!-- Estatísticas dos jogadores serão carregadas aqui -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <h3><i class="fas fa-scroll"></i> Controle da História</h3>
                        <div class="form-group">
                            <label for="masterStoryControl">Avançar/Retroceder Cena</label>
                            <div class="dice-controls">
                                <button class="btn btn-master btn-small" onclick="masterControlScene(-1)">
                                    <i class="fas fa-backward"></i> Cena Anterior
                                </button>
                                <button class="btn btn-master btn-small" onclick="masterControlScene(1)">
                                    Próxima Cena <i class="fas fa-forward"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel master-panel">
                    <h2><i class="fas fa-history"></i> Histórico de Ações</h2>
                    <div class="story-history" id="masterActionLog" style="max-height: 400px;">
                        <!-- Histórico de ações será carregado aqui -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ABA 4: JOGO ONLINE -->
        <div id="game" class="tab-content">
            <!-- LOBBY DE JOGO -->
            <div class="game-area active" id="gameLobby">
                <h2><i class="fas fa-gamepad"></i> Lobby de Jogo</h2>
                <p>Escolha uma história para jogar ou crie sua própria campanha.</p>
                
                <div class="share-container">
                    <h3><i class="fas fa-share-alt"></i> Jogar com Amigos</h3>
                    <p>Para jogar com amigos, compartilhe o código da campanha abaixo:</p>
                    <div class="share-code">
                        <input type="text" id="campaignCodeInput" placeholder="Cole o código da campanha aqui" value="">
                        <button id="joinWithCodeBtn" class="btn btn-success">Entrar com Código</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <h3><i class="fas fa-book-open"></i> Escolha sua História</h3>
                    <div class="story-selector" id="storySelector">
                        <!-- Histórias disponíveis serão carregadas aqui -->
                    </div>
                </div>
                
                <div class="form-group">
                    <h3><i class="fas fa-dragon"></i> Aventuras Disponíveis</h3>
                    <div class="game-types" id="gameTypes">
                        <div class="game-type-card">
                            <div class="game-type-icon">
                                <i class="fas fa-tree"></i>
                            </div>
                            <h3>Floresta Encantada</h3>
                            <p>Explore uma floresta mágica cheia de criaturas e mistérios antigos.</p>
                            <button class="btn btn-forest" onclick="startGame('forest')">
                                <i class="fas fa-play"></i> Jogar
                            </button>
                        </div>
                        
                        <div class="game-type-card dungeon">
                            <div class="game-type-icon">
                                <i class="fas fa-dungeon"></i>
                            </div>
                            <h3>Masmorra Profunda</h3>
                            <p>Desça às profundezas de uma masmorra esquecida em busca de tesouros.</p>
                            <button class="btn btn-dungeon" onclick="startGame('dungeon')">
                                <i class="fas fa-play"></i> Jogar
                            </button>
                        </div>
                        
                        <div class="game-type-card castle">
                            <div class="game-type-icon">
                                <i class="fas fa-chess-rook"></i>
                            </div>
                            <h3>Castelo Amaldiçoado</h3>
                            <p>Liberte um castelo antigo de uma maldição que assombra seus corredores.</p>
                            <button class="btn btn-castle" onclick="startGame('castle')">
                                <i class="fas fa-play"></i> Jogar
                            </button>
                        </div>
                        
                        <div class="game-type-card ocean">
                            <div class="game-type-icon">
                                <i class="fas fa-water"></i>
                            </div>
                            <h3>Ilha Perdida</h3>
                            <p>Navegue até uma ilha misteriosa com segredos ancestrais para descobrir.</p>
                            <button class="btn btn-ocean" onclick="startGame('ocean')">
                                <i class="fas fa-play"></i> Jogar
                            </button>
                        </div>
                        
                        <div class="game-type-card volcano">
                            <div class="game-type-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <h3>Vulcão em Erupção</h3>
                            <p>Enfrente o calor intenso de um vulcão ativo em busca do Cristal de Fogo.</p>
                            <button class="btn btn-volcano" onclick="startGame('volcano')">
                                <i class="fas fa-play"></i> Jogar
                            </button>
                        </div>
                        
                        <div class="game-type-card jungle">
                            <div class="game-type-icon">
                                <i class="fas fa-leaf"></i>
                            </div>
                            <h3>Selva Proibida</h3>
                            <p>Aventure-se por uma selva intocada habitada por tribos antigas e bestas.</p>
                            <button class="btn btn-jungle" onclick="startGame('jungle')">
                                <i class="fas fa-play"></i> Jogar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="campaigns-container" id="joinableCampaigns">
                    <!-- Campanhas disponíveis para jogar -->
                </div>
            </div>
            
            <!-- JOGO DINÂMICO -->
            <div class="game-area" id="dynamicGame">
                <div class="game-header">
                    <div class="game-title">
                        <h2 id="dynamicGameTitle">Aventura Dinâmica</h2>
                        <p class="game-master">Sistema: <span id="dynamicGameSystem">História Gerativa</span> | Progresso: <span id="dynamicProgress">1/15</span></p>
                    </div>
                    <div>
                        <button id="backToLobbyBtn" class="btn btn-danger btn-small">
                            <i class="fas fa-arrow-left"></i> Voltar ao Lobby
                        </button>
                    </div>
                </div>
                
                <!-- CONTAINER DA HISTÓRIA DINÂMICA -->
                <div class="story-container" id="storyContainer">
                    <div class="story-header">
                        <div class="story-title" id="storyTitle">Capítulo 1: O Início da Jornada</div>
                        <div class="story-progress" id="storyProgress">Cena 1 de 15</div>
                    </div>
                    
                    <div class="story-text" id="storyText">
                        Carregando história...
                    </div>
                    
                    <div class="story-choices" id="storyChoices">
                        <!-- Escolhas serão geradas dinamicamente -->
                    </div>
                </div>
                
                <!-- HISTÓRICO DA HISTÓRIA -->
                <div class="story-history" id="storyHistory">
                    <h4><i class="fas fa-history"></i> Histórico de Decisões</h4>
                    <!-- Histórico será preenchido dinamicamente -->
                </div>
                
                <div class="game-content">
                    <div class="game-chat">
                        <h3><i class="fas fa-comments"></i> Chat da Aventura</h3>
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message">
                                <div class="message-sender message-system">Sistema</div>
                                <div class="message-text">Bem-vindo à aventura dinâmica! Suas escolhas moldarão a história.</div>
                                <div class="message-time">Agora mesmo</div>
                            </div>
                        </div>
                        
                        <div class="chat-input">
                            <input type="text" id="chatInput" placeholder="Digite sua mensagem...">
                            <button id="sendMessageBtn"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                    
                    <div class="game-players">
                        <h3><i class="fas fa-users"></i> Personagens</h3>
                        <div class="players-list" id="playersList">
                            <!-- Lista de jogadores -->
                        </div>
                        
                        <div class="dice-roller">
                            <h3><i class="fas fa-dice"></i> Rolador de Dados</h3>
                            <div class="dice-controls">
                                <select id="diceType">
                                    <option value="d4">D4</option>
                                    <option value="d6">D6</option>
                                    <option value="d8">D8</option>
                                    <option value="d10">D10</option>
                                    <option value="d12">D12</option>
                                    <option value="d20" selected>D20</option>
                                    <option value="d100">D100</option>
                                </select>
                                <input type="number" id="diceCount" min="1" max="10" value="1" style="width: 60px;">
                                <button class="btn btn-warning btn-small" id="rollDiceBtn">Rolar Dados</button>
                            </div>
                            <div class="dice-result" id="diceResult">
                                Clique em "Rolar Dados" para começar
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MODAIS -->
        <div id="characterSelectionModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-user"></i> Selecione seu Personagem</h2>
                    <button class="close-modal" id="closeCharacterModal">&times;</button>
                </div>
                
                <div id="characterSelectionList" class="character-selection">
                    <!-- Opções de personagens serão carregadas aqui -->
                </div>
                
                <div class="form-group">
                    <label for="playerName">Seu Nome de Jogador</label>
                    <input type="text" id="playerName" placeholder="Digite seu nome para a sessão">
                </div>
                
                <div class="character-actions">
                    <button id="confirmCharacterBtn" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-check"></i> Entrar na Aventura
                    </button>
                </div>
            </div>
        </div>

        <div id="shareModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <h2><i class="fas fa-share-alt"></i> Compartilhar Campanha</h2>
                    <button class="close-modal" id="closeShareModal">&times;</button>
                </div>
                
                <p>Compartilhe este código com seus amigos para que eles possam entrar na campanha:</p>
                
                <div class="share-code">
                    <input type="text" id="shareCodeDisplay" readonly>
                    <button id="copyCodeBtn" class="btn btn-success">Copiar Código</button>
                </div>
            </div>
        </div>
        
        <!-- Controle de Áudio Flutuante -->
        <div class="audio-controls">
            <button class="audio-btn" id="audioToggle">
                <i class="fas fa-volume-mute"></i>
            </button>
            <div class="volume-control">
                <i class="fas fa-volume-down"></i>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="100" value="50">
                <i class="fas fa-volume-up"></i>
            </div>
        </div>
        
        <div class="notification" id="notification">
            Personagem salvo com sucesso!
        </div>
        
        <footer>
            <p>RPG Web App &copy; 2023 - Jogue RPG com amigos diretamente no navegador</p>
            <p>Todos os dados são salvos localmente no seu navegador.</p>
        </footer>
    </div>

    <script>
        // ==================== SISTEMA COMPLETO DE RPG ====================

        // Constantes de armazenamento
        const STORAGE_CHARACTERS = 'rpg_characters';
        const STORAGE_CAMPAIGNS = 'rpg_campaigns';
        const STORAGE_ACTIVE_GAME = 'rpg_active_game';
        const STORAGE_PLAYER_NAME = 'rpg_player_name';
        const STORAGE_MUSIC_SETTING = 'rpg_music_setting';
        const STORAGE_STATS = 'rpg_stats';
        
        // Elementos DOM
        const characterForm = document.getElementById('characterForm');
        const charactersList = document.getElementById('charactersList');
        const notification = document.getElementById('notification');
        const rpgMusic = document.getElementById('rpgMusic');
        const audioToggle = document.getElementById('audioToggle');
        const headerMusicToggle = document.getElementById('headerMusicToggle');
        const musicStatus = document.getElementById('musicStatus');
        const volumeSlider = document.getElementById('volumeSlider');
        
        // Variáveis globais
        let currentPlayerName = localStorage.getItem(STORAGE_PLAYER_NAME) || '';
        let currentCharacter = null;
        let storyProgress = 1;
        let totalScenes = 15;
        let storyHistory = [];
        let playerChoices = [];
        let gameType = 'forest';
        let currentStory = null;
        let diceRolledCount = parseInt(localStorage.getItem('dice_rolled_count')) || 0;
        
        // Estado do jogo
        let storyState = {
            reputation: 50,
            gold: 100,
            health: 100,
            mana: 100,
            stamina: 100,
            allies: [],
            enemies: [],
            inventory: ['Poção de Cura', 'Tochas', 'Corda', 'Mapa antigo'],
            location: 'starting',
            completedQuests: [],
            activeQuests: ['Encontrar o Amuleto Perdido'],
            storyFlags: {},
            relationshipScores: {},
            discoveredSecrets: []
        };

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
        
        function initializeApp() {
            // Sistema de abas
            setupTabs();
            
            // Carregar dados
            loadCharacters();
            loadCampaigns();
            loadStories();
            updateJoinableCampaigns();
            initializeSampleData();
            
            // Sistema de áudio - CORRIGIDO
            initializeMusic();
            
            // Sistema de estatísticas
            updateMasterDashboard();
            
            // Event listeners
            setupEventListeners();
            
            // Botões corrigidos
            setupSelectionButtons();
        }
        
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    
                    // Atualizar painel do mestre quando acessado
                    if (tabId === 'master') {
                        updateMasterDashboard();
                    }
                });
            });
        }
        
        function setupEventListeners() {
            // Formulário de personagem
            characterForm.addEventListener('submit', handleCharacterSubmit);
            document.getElementById('clearBtn').addEventListener('click', clearForm);
            
            // Formulário de campanha
            document.getElementById('campaignForm').addEventListener('submit', handleCampaignSubmit);
            document.getElementById('clearCampaignBtn').addEventListener('click', clearCampaignForm);
            
            // Chat
            document.getElementById('sendMessageBtn').addEventListener('click', sendChatMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Dados
            document.getElementById('rollDiceBtn').addEventListener('click', rollDice);
            
            // Modais
            document.getElementById('closeCharacterModal').addEventListener('click', () => {
                document.getElementById('characterSelectionModal').style.display = 'none';
                currentCharacter = null;
            });
            
            document.getElementById('confirmCharacterBtn').addEventListener('click', confirmCharacterSelection);
            
            document.getElementById('closeShareModal').addEventListener('click', () => {
                document.getElementById('shareModal').style.display = 'none';
            });
            
            document.getElementById('copyCodeBtn').addEventListener('click', copyShareCode);
            
            // Voltar ao lobby
            document.getElementById('backToLobbyBtn').addEventListener('click', returnToLobby);
            
            // Entrar com código
            document.getElementById('joinWithCodeBtn').addEventListener('click', joinWithCode);
            
            // Controle de volume
            volumeSlider.addEventListener('input', (e) => {
                rpgMusic.volume = e.target.value / 100;
                localStorage.setItem('rpg_music_volume', e.target.value);
            });
            
            // Carregar volume salvo
            const savedVolume = localStorage.getItem('rpg_music_volume');
            if (savedVolume) {
                volumeSlider.value = savedVolume;
                rpgMusic.volume = savedVolume / 100;
            }
        }
        
        // ==================== SISTEMA DE MÚSICA CORRIGIDO ====================
        function initializeMusic() {
            const musicEnabled = localStorage.getItem(STORAGE_MUSIC_SETTING) !== 'false';
            
            // Configurar volume inicial
            rpgMusic.volume = volumeSlider.value / 100;
            rpgMusic.loop = true;
            
            // Configurar para tocar automaticamente (se permitido)
            if (musicEnabled) {
                enableMusic();
            } else {
                disableMusic();
            }
            
            // Configurar eventos de clique para ativar áudio
            setupAudioInteraction();
        }
        
        function enableMusic() {
            const playPromise = rpgMusic.play();
            
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // Reprodução iniciada com sucesso
                    updateMusicUI(true);
                    localStorage.setItem(STORAGE_MUSIC_SETTING, 'true');
                }).catch(error => {
                    // Autoplay bloqueado
                    console.log("Autoplay bloqueado. Aguardando interação do usuário...");
                    updateMusicUI(false);
                    
                    // Habilitar interação para ativar música
                    enableAudioInteraction();
                });
            }
        }
        
        function disableMusic() {
            rpgMusic.pause();
            updateMusicUI(false);
            localStorage.setItem(STORAGE_MUSIC_SETTING, 'false');
        }
        
        function updateMusicUI(isPlaying) {
            if (isPlaying) {
                audioToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
                musicStatus.textContent = 'Música: Ligada';
                audioToggle.style.backgroundColor = 'var(--fantasy)';
            } else {
                audioToggle.innerHTML = '<i class="fas fa-volume-mute"></i>';
                musicStatus.textContent = 'Música: Desligada';
                audioToggle.style.backgroundColor = '#7f8c8d';
            }
        }
        
        function setupAudioInteraction() {
            // Botão de toggle
            audioToggle.addEventListener('click', toggleMusic);
            headerMusicToggle.addEventListener('click', toggleMusic);
            
            // Ativar música no primeiro clique em qualquer lugar
            document.addEventListener('click', function firstClickAudio() {
                if (rpgMusic.paused && localStorage.getItem(STORAGE_MUSIC_SETTING) === 'true') {
                    rpgMusic.play().then(() => {
                        updateMusicUI(true);
                    }).catch(console.error);
                }
                document.removeEventListener('click', firstClickAudio);
            }, { once: true });
        }
        
        function enableAudioInteraction() {
            // Permite que o usuário ative a música clicando
            const enableAudio = () => {
                rpgMusic.play().then(() => {
                    updateMusicUI(true);
                    localStorage.setItem(STORAGE_MUSIC_SETTING, 'true');
                }).catch(console.error);
            };
            
            // Ativar no clique do botão de música
            audioToggle.addEventListener('click', enableAudio);
            headerMusicToggle.addEventListener('click', enableAudio);
        }
        
        function toggleMusic() {
            if (rpgMusic.paused) {
                rpgMusic.play().then(() => {
                    updateMusicUI(true);
                    localStorage.setItem(STORAGE_MUSIC_SETTING, 'true');
                }).catch(console.error);
            } else {
                rpgMusic.pause();
                updateMusicUI(false);
                localStorage.setItem(STORAGE_MUSIC_SETTING, 'false');
            }
        }
        
        // ==================== SISTEMA DE PERSONAGENS ====================
        function handleCharacterSubmit(e) {
            e.preventDefault();
            
            const characterId = document.getElementById('characterId').value;
            const existingCharacter = characterId ? getCharacter(characterId) : null;
            
            const character = {
                id: characterId || Date.now().toString(),
                name: document.getElementById('name').value,
                class: document.getElementById('class').value,
                race: document.getElementById('race').value,
                level: parseInt(document.getElementById('level').value),
                strength: parseInt(document.getElementById('strength').value),
                dexterity: parseInt(document.getElementById('dexterity').value),
                constitution: parseInt(document.getElementById('constitution').value),
                intelligence: parseInt(document.getElementById('intelligence').value),
                wisdom: parseInt(document.getElementById('wisdom').value),
                charisma: parseInt(document.getElementById('charisma').value),
                background: document.getElementById('background').value,
                createdAt: existingCharacter ? existingCharacter.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                stats: {
                    battles: 0,
                    victories: 0,
                    goldCollected: 0,
                    questsCompleted: 0
                }
            };
            
            saveCharacter(character);
            showNotification(characterId ? 'Personagem atualizado!' : 'Personagem criado!');
            loadCharacters();
            clearForm();
            updateMasterDashboard();
        }
        
        function saveCharacter(character) {
            const characters = getCharacters();
            const existingIndex = characters.findIndex(c => c.id === character.id);
            
            if (existingIndex >= 0) {
                characters[existingIndex] = character;
            } else {
                characters.push(character);
            }
            
            localStorage.setItem(STORAGE_CHARACTERS, JSON.stringify(characters));
        }
        
        function getCharacters() {
            const charactersJSON = localStorage.getItem(STORAGE_CHARACTERS);
            return charactersJSON ? JSON.parse(charactersJSON) : [];
        }
        
        function getCharacter(id) {
            const characters = getCharacters();
            return characters.find(c => c.id === id);
        }
        
        function loadCharacters() {
            const characters = getCharacters();
            charactersList.innerHTML = '';
            
            if (characters.length === 0) {
                charactersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <h3>Nenhum personagem criado</h3>
                        <p>Crie seu primeiro personagem usando o formulário ao lado!</p>
                    </div>
                `;
                return;
            }
            
            characters.forEach(character => {
                const card = document.createElement('div');
                card.className = 'character-card';
                card.dataset.id = character.id;
                card.innerHTML = `
                    <h3>${character.name}</h3>
                    <span class="character-class">${character.race} ${character.class}</span>
                    <p>Nível ${character.level}</p>
                    
                    <div class="character-stats">
                        <div class="stat">
                            <span class="stat-value">${character.strength}</span>
                            <span>FOR</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${character.dexterity}</span>
                            <span>DES</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${character.constitution}</span>
                            <span>CON</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${character.intelligence}</span>
                            <span>INT</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${character.wisdom}</span>
                            <span>SAB</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${character.charisma}</span>
                            <span>CAR</span>
                        </div>
                    </div>
                    
                    <p class="character-background">${character.background ? 
                        (character.background.substring(0, 100) + (character.background.length > 100 ? '...' : '')) : 
                        'Sem história definida.'}</p>
                    
                    <div class="character-actions">
                        <button class="action-btn edit-btn" onclick="editCharacter('${character.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteCharacter('${character.id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                        <button class="action-btn join-btn" onclick="selectCharacterForGame('${character.id}')">
                            <i class="fas fa-play"></i> Jogar
                        </button>
                    </div>
                `;
                
                charactersList.appendChild(card);
            });
        }
        
        function editCharacter(id) {
            const character = getCharacter(id);
            if (!character) return;
            
            document.getElementById('characterId').value = character.id;
            document.getElementById('name').value = character.name;
            document.getElementById('class').value = character.class;
            document.getElementById('race').value = character.race;
            document.getElementById('level').value = character.level;
            document.getElementById('strength').value = character.strength;
            document.getElementById('dexterity').value = character.dexterity;
            document.getElementById('constitution').value = character.constitution;
            document.getElementById('intelligence').value = character.intelligence;
            document.getElementById('wisdom').value = character.wisdom;
            document.getElementById('charisma').value = character.charisma;
            document.getElementById('background').value = character.background;
            
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Personagem';
            document.querySelector('[data-tab="characters"]').click();
        }
        
        function deleteCharacter(id) {
            if (confirm('Tem certeza que deseja excluir este personagem?')) {
                const characters = getCharacters();
                const filteredCharacters = characters.filter(c => c.id !== id);
                localStorage.setItem(STORAGE_CHARACTERS, JSON.stringify(filteredCharacters));
                loadCharacters();
                showNotification('Personagem excluído!');
                updateMasterDashboard();
            }
        }
        
        function selectCharacterForGame(id) {
            const character = getCharacter(id);
            if (!character) return;
            
            currentCharacter = character;
            showStorySelection();
        }
        
        function clearForm() {
            characterForm.reset();
            document.getElementById('characterId').value = '';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save"></i> Salvar Personagem';
            document.getElementById('level').value = 1;
            document.getElementById('strength').value = 10;
            document.getElementById('dexterity').value = 10;
            document.getElementById('constitution').value = 10;
            document.getElementById('intelligence').value = 10;
            document.getElementById('wisdom').value = 10;
            document.getElementById('charisma').value = 10;
            
            document.getElementById('class').selectedIndex = 0;
            document.getElementById('race').selectedIndex = 0;
        }
        
        // ==================== SISTEMA DE CAMPANHAS ====================
        function handleCampaignSubmit(e) {
            e.preventDefault();
            
            const campaignId = document.getElementById('campaignId').value;
            const existingCampaign = campaignId ? getCampaign(campaignId) : null;
            
            const campaign = {
                id: campaignId || Date.now().toString(),
                name: document.getElementById('campaignName').value,
                type: document.getElementById('campaignType').value,
                master: document.getElementById('campaignMaster').value,
                maxPlayers: parseInt(document.getElementById('maxPlayers').value),
                description: document.getElementById('campaignDescription').value,
                players: existingCampaign ? existingCampaign.players || [] : [],
                status: 'Aguardando',
                shareCode: existingCampaign ? existingCampaign.shareCode : generateShareCode(),
                createdAt: existingCampaign ? existingCampaign.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            saveCampaign(campaign);
            showNotification(campaignId ? 'Campanha atualizada!' : 'Campanha criada!');
            loadCampaigns();
            updateJoinableCampaigns();
            clearCampaignForm();
            
            if (!campaignId) {
                setTimeout(() => {
                    showShareModal(campaign.shareCode);
                }, 500);
            }
        }
        
        function saveCampaign(campaign) {
            const campaigns = getCampaigns();
            const existingIndex = campaigns.findIndex(c => c.id === campaign.id);
            
            if (existingIndex >= 0) {
                campaigns[existingIndex] = campaign;
            } else {
                campaigns.push(campaign);
            }
            
            localStorage.setItem(STORAGE_CAMPAIGNS, JSON.stringify(campaigns));
        }
        
        function getCampaigns() {
            const campaignsJSON = localStorage.getItem(STORAGE_CAMPAIGNS);
            return campaignsJSON ? JSON.parse(campaignsJSON) : [];
        }
        
        function getCampaign(id) {
            const campaigns = getCampaigns();
            return campaigns.find(c => c.id === id);
        }
        
        function getCampaignByShareCode(shareCode) {
            const campaigns = getCampaigns();
            return campaigns.find(c => c.shareCode === shareCode);
        }
        
        function loadCampaigns() {
            const campaigns = getCampaigns();
            const campaignsList = document.getElementById('campaignsList');
            campaignsList.innerHTML = '';
            
            if (campaigns.length === 0) {
                campaignsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-dungeon"></i>
                        <h3>Nenhuma campanha criada</h3>
                        <p>Crie sua primeira campanha usando o formulário ao lado!</p>
                    </div>
                `;
                return;
            }
            
            campaigns.forEach(campaign => {
                const playersCount = campaign.players ? campaign.players.length : 0;
                const canJoin = playersCount < campaign.maxPlayers;
                const statusClass = campaign.status === 'Aguardando' ? 'aguardando' : 
                                  campaign.status === 'Configurando' ? 'configurando' : 
                                  campaign.status === 'Em andamento' ? 'andamento' : '';
                
                const card = document.createElement('div');
                card.className = 'campaign-card';
                card.dataset.id = campaign.id;
                card.innerHTML = `
                    <h3>${campaign.name}</h3>
                    <span class="campaign-status ${statusClass}">${campaign.status}</span>
                    
                    <div class="campaign-info">
                        <div class="info-item">
                            <span class="stat-value">${campaign.master}</span>
                            <span>MESTRE</span>
                        </div>
                        <div class="info-item">
                            <span class="stat-value">${playersCount}/${campaign.maxPlayers}</span>
                            <span>JOGADORES</span>
                        </div>
                    </div>
                    
                    <p><strong>Tipo:</strong> ${campaign.type}</p>
                    <p><strong>Descrição:</strong> ${campaign.description.length > 80 ? 
                        campaign.description.substring(0, 80) + '...' : campaign.description}</p>
                    
                    <div class="campaign-actions">
                        <button class="action-btn edit-btn" onclick="editCampaign('${campaign.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteCampaign('${campaign.id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                        ${canJoin ? 
                            `<button class="action-btn join-btn" onclick="joinCampaign('${campaign.id}')">
                                <i class="fas fa-play"></i> ${campaign.status === 'Aguardando' ? 'Entrar' : 'Jogar'}
                            </button>` : 
                            `<button class="action-btn" style="background-color: #7f8c8d; color: white;" disabled>
                                <i class="fas fa-users"></i> Lotada
                            </button>`
                        }
                        <button class="action-btn" style="background-color: var(--fantasy); color: white;" 
                                onclick="showShareModal('${campaign.shareCode}')">
                            <i class="fas fa-share-alt"></i> Compartilhar
                        </button>
                    </div>
                `;
                
                campaignsList.appendChild(card);
            });
        }
        
        function editCampaign(id) {
            const campaign = getCampaign(id);
            if (!campaign) return;
            
            document.getElementById('campaignId').value = campaign.id;
            document.getElementById('campaignName').value = campaign.name;
            document.getElementById('campaignType').value = campaign.type;
            document.getElementById('campaignMaster').value = campaign.master;
            document.getElementById('maxPlayers').value = campaign.maxPlayers;
            document.getElementById('campaignDescription').value = campaign.description;
            
            document.getElementById('saveCampaignBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Campanha';
            document.querySelector('[data-tab="campaigns"]').click();
        }
        
        function deleteCampaign(id) {
            if (confirm('Tem certeza que deseja excluir esta campanha?')) {
                const campaigns = getCampaigns();
                const filteredCampaigns = campaigns.filter(c => c.id !== id);
                localStorage.setItem(STORAGE_CAMPAIGNS, JSON.stringify(filteredCampaigns));
                loadCampaigns();
                updateJoinableCampaigns();
                showNotification('Campanha excluída!');
            }
        }
        
        function clearCampaignForm() {
            campaignForm.reset();
            document.getElementById('campaignId').value = '';
            document.getElementById('saveCampaignBtn').innerHTML = '<i class="fas fa-plus-circle"></i> Criar Campanha';
            document.getElementById('maxPlayers').value = 4;
            
            document.getElementById('campaignType').selectedIndex = 0;
            document.getElementById('campaignMaster').selectedIndex = 0;
        }
        
        function generateShareCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // ==================== SISTEMA DE HISTÓRIAS ====================
        function loadStories() {
            const storySelector = document.getElementById('storySelector');
            const stories = getStories();
            
            stories.forEach((story) => {
                const storyOption = document.createElement('div');
                storyOption.className = 'story-option';
                storyOption.dataset.storyId = story.id;
                storyOption.innerHTML = `
                    <div class="story-icon">
                        <i class="${story.icon}"></i>
                    </div>
                    <h4>${story.title}</h4>
                    <p>${story.description}</p>
                    <div class="story-meta">
                        <span><i class="fas fa-clock"></i> ${story.duration}</span> | 
                        <span><i class="fas fa-layer-group"></i> ${story.chapters} capítulos</span>
                    </div>
                `;
                
                storyOption.addEventListener('click', () => {
                    // Remover seleção anterior
                    document.querySelectorAll('.story-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Selecionar esta história
                    storyOption.classList.add('selected');
                    currentStory = story;
                    gameType = story.type;
                    
                    // Mostrar botão de iniciar
                    const startButton = document.createElement('button');
                    startButton.className = `btn btn-${story.type}`;
                    startButton.style.width = '100%';
                    startButton.style.marginTop = '10px';
                    startButton.innerHTML = `<i class="fas fa-play"></i> Iniciar "${story.title}"`;
                    startButton.addEventListener('click', () => startGame(story.type));
                    
                    // Remover botão anterior se existir
                    const oldButton = storyOption.querySelector('button');
                    if (oldButton) oldButton.remove();
                    
                    storyOption.appendChild(startButton);
                });
                
                storySelector.appendChild(storyOption);
            });
        }
        
        function getStories() {
            return [
                {
                    id: 'forest-story',
                    title: 'O Segredo da Floresta Encantada',
                    description: 'Uma floresta antiga esconde segredos mágicos e criaturas lendárias.',
                    type: 'forest',
                    icon: 'fas fa-tree',
                    duration: '2-3 horas',
                    chapters: 15,
                    difficulty: 'Médio'
                },
                {
                    id: 'dungeon-story',
                    title: 'As Profundezas da Masmorra Esquecida',
                    description: 'Uma masmorra abandonada guarda tesouros inimagináveis e perigos mortais.',
                    type: 'dungeon',
                    icon: 'fas fa-dungeon',
                    duration: '3-4 horas',
                    chapters: 18,
                    difficulty: 'Difícil'
                },
                {
                    id: 'castle-story',
                    title: 'O Castelo dos Espíritos',
                    description: 'Um castelo amaldiçoado precisa ser libertado de espíritos vingativos.',
                    type: 'castle',
                    icon: 'fas fa-chess-rook',
                    duration: '2-2.5 horas',
                    chapters: 12,
                    difficulty: 'Médio'
                },
                {
                    id: 'ocean-story',
                    title: 'A Ilha do Tesouro Perdido',
                    description: 'Navegue por mares traiçoeiros em busca de um tesouro lendário.',
                    type: 'ocean',
                    icon: 'fas fa-water',
                    duration: '2.5-3.5 horas',
                    chapters: 14,
                    difficulty: 'Médio'
                },
                {
                    id: 'volcano-story',
                    title: 'O Coração do Vulcão',
                    description: 'Enfrente o calor intenso para recuperar o Cristal de Fogo ancestral.',
                    type: 'volcano',
                    icon: 'fas fa-fire',
                    duration: '2-3 horas',
                    chapters: 13,
                    difficulty: 'Difícil'
                },
                {
                    id: 'jungle-story',
                    title: 'A Selva Proibida',
                    description: 'Descubra os segredos de uma selva intocada e suas tribos antigas.',
                    type: 'jungle',
                    icon: 'fas fa-leaf',
                    duration: '3-4 horas',
                    chapters: 16,
                    difficulty: 'Muito Difícil'
                }
            ];
        }
        
        // ==================== INICIO DO JOGO ====================
        function showStorySelection() {
            if (!currentCharacter) {
                showNotification('Selecione um personagem primeiro!', 'error');
                document.querySelector('[data-tab="characters"]').click();
                return;
            }
            
            document.querySelector('[data-tab="game"]').click();
        }
        
        function startGame(type) {
            if (!currentCharacter) {
                showCharacterSelectionModal();
                return;
            }
            
            gameType = type;
            startDynamicGameSession();
        }
        
        function showCharacterSelectionModal() {
            const characters = getCharacters();
            const selectionList = document.getElementById('characterSelectionList');
            
            selectionList.innerHTML = '';
            
            if (characters.length === 0) {
                selectionList.innerHTML = '<p>Nenhum personagem criado. Crie um personagem primeiro.</p>';
                return;
            }
            
            characters.forEach(character => {
                const option = document.createElement('div');
                option.className = 'character-option';
                option.style.cssText = `
                    padding: 15px;
                    margin-bottom: 10px;
                    background: rgba(255,255,255,0.05);
                    border-radius: 5px;
                    cursor: pointer;
                    transition: all 0.3s;
                `;
                option.dataset.characterId = character.id;
                option.innerHTML = `
                    <h4 style="color: var(--secondary); margin-bottom: 5px;">${character.name}</h4>
                    <p><strong>${character.race} ${character.class}</strong> - Nível ${character.level}</p>
                    <p>FOR ${character.strength} | DES ${character.dexterity} | CON ${character.constitution}</p>
                    <p>INT ${character.intelligence} | SAB ${character.wisdom} | CAR ${character.charisma}</p>
                `;
                
                option.addEventListener('click', function() {
                    document.querySelectorAll('.character-option').forEach(opt => {
                        opt.style.background = 'rgba(255,255,255,0.05)';
                        opt.style.border = 'none';
                    });
                    
                    this.style.background = 'rgba(52, 152, 219, 0.2)';
                    this.style.border = '2px solid var(--secondary)';
                    currentCharacter = character;
                    
                    const playerNameInput = document.getElementById('playerName');
                    if (!playerNameInput.value.trim()) {
                        playerNameInput.value = character.name;
                    }
                });
                
                selectionList.appendChild(option);
            });
            
            document.getElementById('playerName').value = currentPlayerName;
            document.getElementById('characterSelectionModal').style.display = 'flex';
        }
        
        function confirmCharacterSelection() {
            if (!currentCharacter) {
                showNotification('Selecione um personagem!', 'error');
                return;
            }
            
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showNotification('Digite seu nome de jogador!', 'error');
                return;
            }
            
            currentPlayerName = playerName;
            localStorage.setItem(STORAGE_PLAYER_NAME, playerName);
            
            document.getElementById('characterSelectionModal').style.display = 'none';
            startDynamicGameSession();
        }
        
        function startDynamicGameSession() {
            // Resetar estado do jogo
            storyProgress = 1;
            storyHistory = [];
            playerChoices = [];
            
            // Configurar estado baseado no tipo de jogo
            initializeStoryState();
            
            // Mostrar tela de jogo
            document.getElementById('gameLobby').style.display = 'none';
            document.getElementById('dynamicGame').classList.add('active');
            
            // Configurar título e informações
            const gameInfo = getGameInfo(gameType);
            document.getElementById('dynamicGameTitle').textContent = gameInfo.title;
            document.getElementById('dynamicGameSystem').textContent = gameInfo.system;
            document.getElementById('dynamicProgress').textContent = `${storyProgress}/${totalScenes}`;
            
            // Atualizar interface
            updatePlayersList();
            
            // Iniciar primeira cena
            generateStoryScene();
            
            // Salvar jogo ativo
            saveActiveGame();
            
            // Mensagens iniciais
            addChatMessage('Sistema', `Bem-vindo, ${currentPlayerName}! Sua aventura começa agora.`, 'system');
            addChatMessage('Sistema', `Personagem: ${currentCharacter.name} - ${currentCharacter.race} ${currentCharacter.class}`, 'system');
            addChatMessage('Sistema', `História: ${gameInfo.title}`, 'system');
            
            // Atualizar painel do mestre
            updateMasterDashboard();
            logMasterAction(`${currentPlayerName} iniciou a aventura: ${gameInfo.title}`);
        }
        
        function initializeStoryState() {
            storyState = {
                reputation: 50,
                gold: 100,
                health: 100,
                mana: 100,
                stamina: 100,
                allies: [],
                enemies: [],
                inventory: ['Poção de Cura', 'Tochas', 'Corda', 'Mapa antigo'],
                location: 'starting',
                completedQuests: [],
                activeQuests: ['Encontrar o Amuleto Perdido'],
                storyFlags: {},
                relationshipScores: {},
                discoveredSecrets: []
            };
            
            // Configurações específicas por tipo
            switch(gameType) {
                case 'forest':
                    storyState.inventory.push('Sementes mágicas', 'Pergaminho élfico');
                    storyState.activeQuests.push('Proteger o Bosque Sagrado');
                    break;
                case 'dungeon':
                    storyState.inventory.push('Lanterna', 'Chave antiga');
                    storyState.activeQuests.push('Encontrar a Sala do Tesouro');
                    storyState.gold = 50;
                    break;
                case 'castle':
                    storyState.inventory.push('Símbolo sagrado', 'Óleo para lâmpadas');
                    storyState.activeQuests.push('Quebrar a Maldição');
                    break;
                case 'ocean':
                    storyState.inventory.push('Bússola', 'Rede de pesca');
                    storyState.activeQuests.push('Encontrar a Ilha Perdida');
                    break;
                case 'volcano':
                    storyState.inventory.push('Amuleto de resistência ao fogo', 'Água sagrada');
                    storyState.activeQuests.push('Recuperar o Cristal de Fogo');
                    storyState.health = 80;
                    break;
                case 'jungle':
                    storyState.inventory.push('Antídoto', 'Faca de caça');
                    storyState.activeQuests.push('Encontrar a Cidade Perdida');
                    storyState.reputation = 30;
                    break;
            }
        }
        
        function getGameInfo(type) {
            const games = {
                forest: { title: 'Floresta Encantada', system: 'Sistema de Natureza' },
                dungeon: { title: 'Masmorra Profunda', system: 'Sistema de Exploração' },
                castle: { title: 'Castelo dos Espíritos', system: 'Sistema de Mistério' },
                ocean: { title: 'Ilha do Tesouro Perdido', system: 'Sistema de Navegação' },
                volcano: { title: 'Coração do Vulcão', system: 'Sistema de Sobrevivência' },
                jungle: { title: 'Selva Proibida', system: 'Sistema de Exploração' }
            };
            
            return games[type] || { title: 'Aventura Personalizada', system: 'Sistema Adaptativo' };
        }
        
        // ==================== GERAÇÃO DE HISTÓRIA DINÂMICA ====================
        function generateStoryScene() {
            document.getElementById('storyProgress').textContent = `Cena ${storyProgress} de ${totalScenes}`;
            document.getElementById('dynamicProgress').textContent = `${storyProgress}/${totalScenes}`;
            
            let sceneData;
            
            // Gerar cena baseada no tipo de jogo e progresso
            sceneData = generateSceneByTypeAndProgress();
            
            // Atualizar interface
            document.getElementById('storyTitle').textContent = sceneData.title;
            document.getElementById('storyText').innerHTML = sceneData.description;
            
            // Gerar escolhas
            generateChoices(sceneData.choices);
            
            // Adicionar ao histórico
            addToStoryHistory(sceneData.title, storyProgress);
            
            // Log para o mestre
            logMasterAction(`Cena ${storyProgress} iniciada: ${sceneData.title}`);
        }
        
        function generateSceneByTypeAndProgress() {
            const scenes = {
                forest: getForestScenes(),
                dungeon: getDungeonScenes(),
                castle: getCastleScenes(),
                ocean: getOceanScenes(),
                volcano: getVolcanoScenes(),
                jungle: getJungleScenes()
            };
            
            const gameScenes = scenes[gameType] || getForestScenes();
            const sceneIndex = Math.min(storyProgress - 1, gameScenes.length - 1);
            
            return gameScenes[sceneIndex] || gameScenes[0];
        }
        
        function getForestScenes() {
            const scenes = [];
            
            for (let i = 1; i <= 15; i++) {
                scenes.push({
                    title: `Capítulo ${i}: ${getForestChapterTitle(i)}`,
                    description: getForestChapterDescription(i),
                    choices: generateChoiceSet(getChoiceTypesForScene(i))
                });
            }
            
            return scenes;
        }
        
        function getForestChapterTitle(chapter) {
            const titles = [
                'A Entrada da Floresta',
                'O Rio Mágico',
                'A Clareira dos Espíritos',
                'A Árvore Ancestral',
                'O Jardim das Criaturas',
                'As Ruínas Élficas',
                'A Câmara dos Sonhos',
                'A Ponte das Almas',
                'O Santuário dos Druídas',
                'A Fonte da Vida',
                'O Vale das Sombras',
                'O Pico da Águia',
                'O Labirinto de Videiras',
                'O Coração da Floresta',
                'O Despertar'
            ];
            
            return titles[chapter - 1] || 'Capítulo Desconhecido';
        }
        
        function getForestChapterDescription(chapter) {
            const descriptions = [
                `Você está diante da imensa Floresta Encantada de Eldoria. Árvores centenárias se erguem como guardiões silenciosos, e um ar de magia paira no ambiente. Um velho druída se aproxima: "Cuidado, aventureiro. A floresta testa todos que entram. Alguns não retornam..."`,
                `Um rio de águas cristalinas corta a floresta. Peixes brilhantes nadam em padrões hipnóticos. Na margem oposta, você vê uma criatura ferida. As águas parecem ter propriedades curativas, mas atravessar pode ser perigoso.`,
                `Você encontra uma clareira onde luzes flutuantes dançam no ar. Espíritos da floresta observam seus movimentos. No centro, um altar antigo contém um artefato brilhante. Os espíritos parecem testar suas intenções.`,
                `Uma árvore gigantesca, maior que qualquer outra, domina esta parte da floresta. Suas raízes formam passagens subterrâneas. Você sente uma energia pulsante vindo de dentro da árvore. Guardiões de madeira protegem a entrada.`,
                `Um jardim mágico onde criaturas fantásticas vivem em harmonia. Fadas, unicórnios e criaturas das sombras coexistem aqui. Cada criatura reage de forma diferente à sua presença. Algumas são curiosas, outras hostis.`,
                `Ruínas de uma civilização élfica perdida emergem da vegetação. Inscrições antigas contam histórias de grande poder. Armadilhas mágicas ainda funcionam, protegendo segredos há muito esquecidos.`,
                `Uma caverna natural com cristais que emitem luz suave. O ar aqui induz visões e revelações. Você vê visões do passado e possíveis futuros. Cada cristal mostra uma realidade diferente.`,
                `Uma ponte feita de luz conecta duas partes da floresta. Almas antigas vagueiam pela ponte, contando histórias. Cruzar a ponte requer passar por um teste espiritual. As almas podem ajudar ou atrapalhar.`,
                `Um círculo de pedras onde druídas realizam seus rituais. O poder da natureza é palpável aqui. Os druídas observam você, decidindo se você é digno de seu conhecimento.`,
                `A fonte que dá vida a toda a floresta. Suas águas curam qualquer ferimento e concedem sabedoria. Guardada por criaturas anciãs, a fonte só revela seus segredos para os puros de coração.`,
                `Uma área onde a luz não penetra. Criaturas das sombras habitam este lugar, testando a coragem dos visitantes. O medo é sua maior arma aqui. Superá-lo é a única forma de progredir.`,
                `O ponto mais alto da floresta. Daqui você pode ver toda a extensão de Eldoria. Uma águia gigante faz seu ninho aqui. Ela conhece todos os segredos da floresta.`,
                `Videiras mágicas formam um labirinto em constante movimento. Escolher o caminho certo é um desafio mental. As plantas respondem às suas emoções, tornando o caminho mais fácil ou difícil.`,
                `O centro místico da floresta. Aqui, todas as formas de vida estão conectadas. Você sente a consciência coletiva da floresta. Ela julgará suas ações até agora.`,
                `A floresta revela seu segredo final. Tudo que você aprendeu e todas as suas escolhas levam a este momento. A verdade sobre o Amuleto Perdido está prestes a ser revelada. A floresta aguarda sua decisão final.`
            ];
            
            const description = descriptions[chapter - 1] || 'A aventura continua...';
            return `<p>${description}</p><p><strong>Estado Atual:</strong> Vida: ${storyState.health} | Ouro: ${storyState.gold} | Reputação: ${storyState.reputation}</p>`;
        }
        
        function getDungeonScenes() {
            // Implementação similar para masmorra
            const scenes = [];
            for (let i = 1; i <= 15; i++) {
                scenes.push({
                    title: `Nível ${i}: ${getDungeonLevelTitle(i)}`,
                    description: `<p>Você desce mais fundo na masmorra. ${getDungeonLevelDescription(i)}</p><p><strong>Profundidade:</strong> Nível ${i} | Ouro: ${storyState.gold} | Vida: ${storyState.health}</p>`,
                    choices: generateChoiceSet(getChoiceTypesForScene(i))
                });
            }
            return scenes;
        }
        
        // Adicione funções similares para outros tipos de aventura
        
        function getChoiceTypesForScene(scene) {
            const typeSets = [
                ['explore', 'talk', 'avoid', 'magic'],
                ['help', 'explore', 'magic', 'stealth'],
                ['diplomatic', 'magic', 'stealth', 'aggressive'],
                ['diplomatic', 'magic', 'stealth', 'aggressive'],
                ['diplomatic', 'magic', 'explore', 'stealth'],
                ['explore', 'magic', 'stealth', 'diplomatic'],
                ['magic', 'explore', 'diplomatic', 'stealth'],
                ['diplomatic', 'magic', 'stealth', 'aggressive'],
                ['diplomatic', 'magic', 'explore', 'stealth'],
                ['diplomatic', 'magic', 'stealth', 'aggressive'],
                ['aggressive', 'magic', 'stealth', 'diplomatic'],
                ['diplomatic', 'magic', 'explore', 'stealth'],
                ['magic', 'stealth', 'explore', 'diplomatic'],
                ['diplomatic', 'magic', 'stealth', 'aggressive'],
                ['diplomatic', 'magic', 'aggressive', 'stealth']
            ];
            
            return typeSets[scene - 1] || typeSets[0];
        }
        
        function generateChoiceSet(types) {
            return types.map(type => generateChoiceByType(type));
        }
        
        function generateChoiceByType(type) {
            const choices = {
                aggressive: [
                    { text: "Atacar frontalmente", consequence: "Confronto direto, alto risco e alta recompensa" },
                    { text: "Intimidar os oponentes", consequence: "Teste de força, pode evitar combate" },
                    { text: "Forçar passagem", consequence: "Avança rapidamente, mas toma dano" },
                    { text: "Destruir obstáculos", consequence: "Remove barreiras, consome recursos" }
                ],
                diplomatic: [
                    { text: "Negociar pacificamente", consequence: "Ganha informações e aliados, leva tempo" },
                    { text: "Oferecer ajuda", consequence: "Aumenta reputação, atrasa progresso" },
                    { text: "Buscar acordo", consequence: "Todos ganham algo, requer concessões" },
                    { text: "Diplomacia cuidadosa", consequence: "Evita conflitos, teste de Carisma" }
                ],
                stealth: [
                    { text: "Esgueirar-se silenciosamente", consequence: "Evita detecção, perde oportunidades" },
                    { text: "Observar primeiro", consequence: "Obtém vantagem tática, consome tempo" },
                    { text: "Criar distração", consequence: "Desvia atenção, usa recursos" },
                    { text: "Usar disfarce", consequence: "Passa despercebido, ações limitadas" }
                ],
                magic: [
                    { text: "Magia de ilusão", consequence: "Engana inimigos, requer concentração" },
                    { text: "Invocar aliado", consequence: "Ajuda temporária, drena energia" },
                    { text: "Escudo protetor", consequence: "Proteção forte, ofensiva reduzida" },
                    { text: "Leitura mágica", consequence: "Obtém conhecimento, atrai atenção" }
                ],
                explore: [
                    { text: "Explorar área", consequence: "Encontra itens escondidos, consome tempo" },
                    { text: "Procurar pistas", consequence: "Descobre segredos, risco de armadilhas" },
                    { text: "Mapear região", consequence: "Vantagem futura, progresso lento" },
                    { text: "Coletar recursos", consequence: "Ganha suprimentos, exposição ao perigo" }
                ],
                help: [
                    { text: "Ajudar criatura", consequence: "Ganha aliado, consome recursos" },
                    { text: "Curar feridos", consequence: "Aumenta reputação, usa poções" },
                    { text: "Proteger vulneráveis", consequence: "Gratidão futura, risco imediato" },
                    { text: "Ensinar habilidades", consequence: "Fortalece aliados, leva tempo" }
                ],
                talk: [
                    { text: "Conversar calmamente", consequence: "Obtém informações, construção de confiança" },
                    { text: "Questionar testemunhas", consequence: "Descobre segredos, pode ofender" },
                    { text: "Negociar termos", consequence: "Acordo benéfico, requer habilidades sociais" },
                    { text: "Persuadir com argumentos", consequence: "Muda opiniões, teste de Carisma" }
                ],
                avoid: [
                    { text: "Contornar obstáculo", consequence: "Evita perigo, caminho mais longo" },
                    { text: "Esperar momento certo", consequence: "Ação segura, perde tempo" },
                    { text: "Procurar alternativa", consequence: "Solução criativa, requer percepção" },
                    { text: "Recuar estrategicamente", consequence: "Vive para lutar outro dia, perde progresso" }
                ]
            };
            
            const typeChoices = choices[type] || choices.diplomatic;
            const randomChoice = typeChoices[Math.floor(Math.random() * typeChoices.length)];
            
            return {
                text: randomChoice.text,
                consequence: randomChoice.consequence,
                type: type,
                effect: generateEffectForType(type)
            };
        }
        
        function generateEffectForType(type) {
            const effects = {
                aggressive: { gold: [10, 40], reputation: [-15, 5], health: [-20, -5] },
                diplomatic: { gold: [-5, 15], reputation: [10, 25], health: [0, 15] },
                stealth: { gold: [5, 25], reputation: [0, 15], health: [-10, 0] },
                magic: { gold: [-10, 20], reputation: [5, 20], health: [-15, 10] },
                explore: { gold: [0, 30], reputation: [0, 10], health: [-5, 5] },
                help: { gold: [-20, 10], reputation: [15, 30], health: [0, 20] },
                talk: { gold: [-10, 10], reputation: [5, 25], health: [0, 10] },
                avoid: { gold: [0, 10], reputation: [-5, 5], health: [5, 15] }
            };
            
            return effects[type] || effects.diplomatic;
        }
        
        function generateChoices(choicesData) {
            const choicesContainer = document.getElementById('storyChoices');
            choicesContainer.innerHTML = '';
            
            choicesData.forEach((choice, index) => {
                const choiceButton = document.createElement('button');
                choiceButton.className = `story-choice choice-${choice.type}`;
                choiceButton.id = `choice-${index}`;
                choiceButton.innerHTML = `
                    <div class="choice-text">${choice.text}</div>
                    <div class="choice-consequence">${choice.consequence}</div>
                `;
                
                choiceButton.addEventListener('click', () => handleChoice(choice, index));
                choicesContainer.appendChild(choiceButton);
            });
        }
        
        function handleChoice(choice, choiceIndex) {
            // Desabilitar escolhas
            document.querySelectorAll('.story-choice').forEach(btn => {
                btn.disabled = true;
            });
            
            // Registrar escolha
            playerChoices.push({
                scene: storyProgress,
                choice: choice.text,
                type: choice.type,
                timestamp: new Date().toLocaleTimeString()
            });
            
            // Aplicar efeitos
            applyChoiceEffects(choice.effect);
            
            // Mostrar resultado
            showChoiceResult(choice, choiceIndex);
            
            // Chat
            addChatMessage(currentPlayerName, `Escolheu: ${choice.text}`, 'player');
            
            // Log do mestre
            logMasterAction(`${currentPlayerName} escolheu: ${choice.text}`);
            
            // Próxima cena
            setTimeout(() => {
                storyProgress++;
                
                if (storyProgress <= totalScenes) {
                    generateStoryScene();
                } else {
                    endGame();
                }
            }, 2500);
        }
        
        function applyChoiceEffects(effect) {
            // Ouro
            if (effect.gold) {
                const goldChange = getRandomInRange(effect.gold[0], effect.gold[1]);
                storyState.gold += goldChange;
                if (goldChange !== 0) {
                    addChatMessage('Sistema', `Ouro ${goldChange > 0 ? '+' : ''}${goldChange}`, 'system');
                }
            }
            
            // Reputação
            if (effect.reputation) {
                const repChange = getRandomInRange(effect.reputation[0], effect.reputation[1]);
                storyState.reputation = clamp(storyState.reputation + repChange, 0, 100);
                if (repChange !== 0) {
                    addChatMessage('Sistema', `Reputação ${repChange > 0 ? '+' : ''}${repChange}`, 'system');
                }
            }
            
            // Vida
            if (effect.health) {
                const healthChange = getRandomInRange(effect.health[0], effect.health[1]);
                storyState.health = clamp(storyState.health + healthChange, 0, 100);
                if (healthChange !== 0) {
                    addChatMessage('Sistema', `Vida ${healthChange > 0 ? '+' : ''}${healthChange}`, 'system');
                }
            }
            
            // Atualizar dashboard
            updateMasterDashboard();
        }
        
        function getRandomInRange(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }
        
        function showChoiceResult(choice, choiceIndex) {
            const results = [
                "Suas ações têm consequências...",
                "O destino responde à sua escolha...",
                "As coisas não saem exatamente como planejado...",
                "Sua decisão altera o curso dos eventos...",
                "Resultados inesperados surgem de sua ação..."
            ];
            
            const result = results[Math.floor(Math.random() * results.length)];
            const choiceButton = document.getElementById(`choice-${choiceIndex}`);
            
            // Efeito visual
            choiceButton.style.transform = 'scale(1.05)';
            choiceButton.style.boxShadow = '0 0 20px rgba(255, 255, 255, 0.5)';
            choiceButton.style.borderColor = 'var(--light)';
            
            // Adicionar resultado ao texto
            const resultHTML = `
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; border-left: 3px solid var(--warning);">
                    <p><strong><i class="fas fa-exclamation-circle"></i> ${result}</strong></p>
                    <p>Você escolheu: <em>"${choice.text}"</em></p>
                    <p><small>${choice.consequence}</small></p>
                </div>
            `;
            
            document.getElementById('storyText').innerHTML += resultHTML;
        }
        
        function addToStoryHistory(sceneTitle, sceneNumber) {
            const historyContainer = document.getElementById('storyHistory');
            
            // Adicionar cena
            const sceneItem = document.createElement('div');
            sceneItem.className = 'history-item';
            sceneItem.innerHTML = `<strong>Cena ${sceneNumber}:</strong> ${sceneTitle}`;
            historyContainer.appendChild(sceneItem);
            
            // Adicionar última escolha se houver
            if (playerChoices.length > 0) {
                const lastChoice = playerChoices[playerChoices.length - 1];
                if (lastChoice.scene === sceneNumber - 1) {
                    const choiceItem = document.createElement('div');
                    choiceItem.className = 'history-item';
                    choiceItem.style.paddingLeft = '20px';
                    choiceItem.innerHTML = `
                        <span class="history-choice">↳ ${lastChoice.choice}</span>
                        <span class="history-result"> (${lastChoice.timestamp})</span>
                    `;
                    historyContainer.appendChild(choiceItem);
                }
            }
            
            // Scroll para o final
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }
        
        // ==================== FIM DO JOGO ====================
        function endGame() {
            document.getElementById('storyTitle').textContent = "Fim da Jornada";
            
            // Calcular pontuação final
            const finalScore = calculateFinalScore();
            
            // Determinar ending baseado na reputação
            let ending = getEndingBasedOnReputation();
            
            const endingHTML = `
                <div class="story-text">
                    <h3>Sua Aventura Chegou ao Fim!</h3>
                    
                    <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h4>Resumo Final</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0;">
                            <div><strong>Personagem:</strong> ${currentCharacter.name}</div>
                            <div><strong>Classe:</strong> ${currentCharacter.race} ${currentCharacter.class}</div>
                            <div><strong>Ouro Final:</strong> ${storyState.gold}</div>
                            <div><strong>Reputação:</strong> ${storyState.reputation}/100</div>
                            <div><strong>Vida Final:</strong> ${storyState.health}/100</div>
                            <div><strong>Pontuação:</strong> ${finalScore}</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(39, 174, 96, 0.2); padding: 20px; border-radius: 10px; border-left: 4px solid var(--success);">
                        <h4>${ending.title}</h4>
                        <p>${ending.description}</p>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4>Conquistas</h4>
                        <ul>
                            <li>${storyState.completedQuests.length} missões completadas</li>
                            <li>${storyState.allies.length} aliados conquistados</li>
                            <li>${storyState.discoveredSecrets.length} segredos descobertos</li>
                            <li>${playerChoices.length} decisões tomadas</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('storyText').innerHTML = endingHTML;
            
            // Opções finais
            document.getElementById('storyChoices').innerHTML = `
                <button class="story-choice choice-diplomatic" onclick="restartGame()">
                    <div class="choice-text">Jogar Novamente</div>
                    <div class="choice-consequence">Começar uma nova aventura</div>
                </button>
                <button class="story-choice choice-aggressive" onclick="returnToLobby()">
                    <div class="choice-text">Voltar ao Lobby</div>
                    <div class="choice-consequence">Retornar ao menu principal</div>
                </button>
                <button class="story-choice choice-magic" onclick="saveAdventureSummary()">
                    <div class="choice-text">Salvar Resumo</div>
                    <div class="choice-consequence">Salvar esta aventura no histórico</div>
                </button>
            `;
            
            addChatMessage('Sistema', 'A aventura chegou ao fim! ' + ending.chatMessage, 'system');
            
            // Atualizar estatísticas do personagem
            updateCharacterStats();
            
            // Log do mestre
            logMasterAction(`${currentPlayerName} completou a aventura com pontuação: ${finalScore}`);
        }
        
        function calculateFinalScore() {
            let score = 0;
            score += storyState.gold / 10;
            score += storyState.reputation * 2;
            score += storyState.health;
            score += storyState.completedQuests.length * 50;
            score += storyState.allies.length * 30;
            score += storyState.discoveredSecrets.length * 40;
            return Math.round(score);
        }
        
        function getEndingBasedOnReputation() {
            if (storyState.reputation >= 90) {
                return {
                    title: "Lenda Viva",
                    description: "Você se tornou uma lenda! Suas ações serão cantadas em canções por gerações. A floresta o aceita como seu protetor.",
                    chatMessage: "Um novo herói nasceu! Sua lenda será contada por séculos."
                };
            } else if (storyState.reputation >= 70) {
                return {
                    title: "Herói Honorável",
                    description: "Você completou sua missão com honra e dignidade. O povo o respeita e as portas estão abertas para você.",
                    chatMessage: "Uma jornada bem-sucedida! O reino o saúda como herói."
                };
            } else if (storyState.reputation >= 50) {
                return {
                    title: "Aventureiro Bem-sucedido",
                    description: "Você alcançou seu objetivo, mas algumas escolhas foram questionáveis. Ainda assim, completou o que se propôs a fazer.",
                    chatMessage: "Missão cumprida, mas alguns olhares desconfiados seguem você."
                };
            } else if (storyState.reputation >= 30) {
                return {
                    title: "Sobrevivente Controverso",
                    description: "Você sobreviveu, mas a um custo. Sua reputação está manchada e alguns o veem como um oportunista.",
                    chatMessage: "Você sobreviveu, mas nem todos estão felizes com seus métodos."
                };
            } else {
                return {
                    title: "Pária ou Vilão",
                    description: "Suas ações o tornaram um pária ou mesmo um vilão. Você alcançou seu objetivo, mas será lembrado como uma figura sombria.",
                    chatMessage: "O fim justifica os meios? Sua jornada termina na sombra."
                };
            }
        }
        
        function updateCharacterStats() {
            const character = getCharacter(currentCharacter.id);
            if (!character) return;
            
            character.stats = character.stats || {};
            character.stats.battles = (character.stats.battles || 0) + 1;
            character.stats.victories = (character.stats.victories || 0) + 1;
            character.stats.goldCollected = (character.stats.goldCollected || 0) + storyState.gold;
            character.stats.questsCompleted = (character.stats.questsCompleted || 0) + storyState.completedQuests.length;
            
            saveCharacter(character);
        }
        
        function saveAdventureSummary() {
            const summary = {
                character: currentCharacter.name,
                date: new Date().toLocaleString(),
                score: calculateFinalScore(),
                gold: storyState.gold,
                reputation: storyState.reputation,
                questsCompleted: storyState.completedQuests.length,
                allies: storyState.allies.length,
                choices: playerChoices.length
            };
            
            // Salvar no localStorage
            const summaries = JSON.parse(localStorage.getItem('adventure_summaries') || '[]');
            summaries.push(summary);
            localStorage.setItem('adventure_summaries', JSON.stringify(summaries));
            
            showNotification('Aventura salva no histórico!', 'success');
        }
        
        function restartGame() {
            storyProgress = 1;
            playerChoices = [];
            initializeStoryState();
            generateStoryScene();
        }
        
        function returnToLobby() {
            document.getElementById('dynamicGame').classList.remove('active');
            document.getElementById('gameLobby').style.display = 'block';
            currentCharacter = null;
            localStorage.removeItem(STORAGE_ACTIVE_GAME);
        }
        
        // ==================== SISTEMA DE CHAT ====================
        function sendChatMessage() {
            const message = document.getElementById('chatInput').value.trim();
            if (!message) return;
            
            addChatMessage(currentPlayerName, message, 'player');
            document.getElementById('chatInput').value = '';
            
            // Resposta do sistema (simulada)
            setTimeout(() => {
                const responses = [
                    "Interessante observação... continue sua jornada.",
                    "Isso pode ter implicações importantes para a história.",
                    "Os outros ouvem suas palavras atentamente.",
                    "Sua decisão afetará o desenrolar dos eventos.",
                    "Um caminho perigoso, mas necessário."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                addChatMessage('Sistema', randomResponse, 'system');
            }, 1000 + Math.random() * 2000);
        }
        
        function addChatMessage(sender, message, type) {
            const chatMessages = document.getElementById('chatMessages');
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            let senderClass = 'message-player';
            if (type === 'system') senderClass = 'message-system';
            if (type === 'master') senderClass = 'message-master';
            
            messageDiv.innerHTML = `
                <div class="message-sender ${senderClass}">${sender}</div>
                <div class="message-text">${message}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Log para o mestre se não for mensagem do sistema
            if (type !== 'system') {
                logMasterAction(`${sender}: ${message}`);
            }
        }
        
        // ==================== ROLADOR DE DADOS ====================
        function rollDice() {
            const diceType = document.getElementById('diceType').value;
            const diceCount = parseInt(document.getElementById('diceCount').value);
            const sides = parseInt(diceType.substring(1));
            
            let total = 0;
            let rolls = [];
            
            for (let i = 0; i < diceCount; i++) {
                const roll = Math.floor(Math.random() * sides) + 1;
                rolls.push(roll);
                total += roll;
            }
            
            let resultText;
            if (diceCount === 1) {
                resultText = `🎲 Resultado: ${rolls[0]}`;
            } else {
                resultText = `🎲 Resultados: ${rolls.join(' + ')} = ${total}`;
            }
            
            document.getElementById('diceResult').textContent = resultText;
            
            const diceName = diceCount === 1 ? diceType : `${diceCount}${diceType}`;
            addChatMessage(currentPlayerName, `Rolou ${diceName}: ${resultText}`, 'player');
            
            // Atualizar contador
            diceRolledCount++;
            localStorage.setItem('dice_rolled_count', diceRolledCount.toString());
            updateMasterDashboard();
            
            // Log do mestre
            logMasterAction(`${currentPlayerName} rolou ${diceName}: ${total}`);
        }
        
        // ==================== PAINEL DO MESTRE ====================
        function updateMasterDashboard() {
            const characters = getCharacters();
            const campaigns = getCampaigns();
            
            // Contadores
            document.getElementById('activePlayersCount').textContent = characters.length;
            document.getElementById('activeCampaignsCount').textContent = campaigns.length;
            document.getElementById('totalCharactersCount').textContent = characters.length;
            document.getElementById('diceRolledCount').textContent = diceRolledCount;
            
            // Estatísticas dos jogadores
            updatePlayerStats(characters);
            
            // Histórico de ações
            updateMasterActionLog();
        }
        
        function updatePlayerStats(characters) {
            const statsContainer = document.getElementById('masterPlayerStats');
            statsContainer.innerHTML = '';
            
            if (characters.length === 0) {
                statsContainer.innerHTML = '<p>Nenhum personagem criado ainda.</p>';
                return;
            }
            
            characters.forEach(character => {
                const stats = character.stats || {};
                const statRow = document.createElement('div');
                statRow.className = 'stat-row';
                statRow.innerHTML = `
                    <span><strong>${character.name}</strong> (${character.race} ${character.class})</span>
                    <span>
                        Nvl ${character.level} | 
                        Batalhas: ${stats.battles || 0} | 
                        Vitórias: ${stats.victories || 0} | 
                        Ouro: ${stats.goldCollected || 0}
                    </span>
                `;
                statsContainer.appendChild(statRow);
            });
        }
        
        function logMasterAction(action) {
            const actionLog = document.getElementById('masterActionLog');
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const actionItem = document.createElement('div');
            actionItem.className = 'history-item';
            actionItem.innerHTML = `<strong>[${timeString}]</strong> ${action}`;
            
            actionLog.appendChild(actionItem);
            actionLog.scrollTop = actionLog.scrollHeight;
            
            // Manter apenas as últimas 50 ações
            const items = actionLog.querySelectorAll('.history-item');
            if (items.length > 50) {
                items[0].remove();
            }
        }
        
        function updateMasterActionLog() {
            // Esta função atualiza o log de ações se necessário
        }
        
        function masterControlScene(direction) {
            if (direction > 0 && storyProgress < totalScenes) {
                storyProgress++;
                generateStoryScene();
                logMasterAction(`Mestre avançou para cena ${storyProgress}`);
            } else if (direction < 0 && storyProgress > 1) {
                storyProgress--;
                generateStoryScene();
                logMasterAction(`Mestre retrocedeu para cena ${storyProgress}`);
            }
        }
        
        // ==================== SISTEMA MULTIPLAYER ====================
        function updateJoinableCampaigns() {
            const campaigns = getCampaigns();
            const joinableCampaigns = document.getElementById('joinableCampaigns');
            
            joinableCampaigns.innerHTML = '';
            
            if (campaigns.length === 0) {
                joinableCampaigns.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-dungeon"></i>
                        <h3>Nenhuma campanha disponível</h3>
                        <p>Crie uma campanha na aba "Campanhas" para começar a jogar!</p>
                    </div>
                `;
                return;
            }
            
            campaigns.forEach(campaign => {
                const playersCount = campaign.players ? campaign.players.length : 0;
                const canJoin = playersCount < campaign.maxPlayers && campaign.status === 'Aguardando';
                
                const card = document.createElement('div');
                card.className = 'campaign-card';
                card.dataset.id = campaign.id;
                card.innerHTML = `
                    <h3>${campaign.name}</h3>
                    <span class="campaign-status">${campaign.status}</span>
                    
                    <div class="campaign-info">
                        <div class="info-item">
                            <span class="stat-value">${campaign.master}</span>
                            <span>MESTRE</span>
                        </div>
                        <div class="info-item">
                            <span class="stat-value">${playersCount}/${campaign.maxPlayers}</span>
                            <span>JOGADORES</span>
                        </div>
                    </div>
                    
                    <p><strong>Tipo:</strong> ${campaign.type}</p>
                    
                    <div class="campaign-actions">
                        ${canJoin ? 
                            `<button class="action-btn join-btn" onclick="joinCampaign('${campaign.id}')">
                                <i class="fas fa-play"></i> Entrar
                            </button>` : 
                            `<button class="action-btn" style="background-color: #7f8c8d; color: white;" disabled>
                                <i class="fas fa-users"></i> ${campaign.status === 'Configurando' ? 'Configurando' : 'Lotada'}
                            </button>`
                        }
                        <button class="action-btn" style="background-color: var(--fantasy); color: white;" 
                                onclick="showShareModal('${campaign.shareCode}')">
                            <i class="fas fa-share-alt"></i> Compartilhar
                        </button>
                    </div>
                `;
                
                joinableCampaigns.appendChild(card);
            });
        }
        
        function joinCampaign(campaignId) {
            const characters = getCharacters();
            if (characters.length === 0) {
                showNotification('Crie pelo menos um personagem antes de entrar em uma campanha!', 'error');
                document.querySelector('[data-tab="characters"]').click();
                return;
            }
            
            showNotification('Conectando à campanha...', 'warning');
            
            setTimeout(() => {
                showNotification('Sistema multiplayer em desenvolvimento! Use o modo solo por enquanto.', 'warning');
            }, 1000);
        }
        
        function joinWithCode() {
            const shareCode = document.getElementById('campaignCodeInput').value.trim().toUpperCase();
            if (!shareCode) {
                showNotification('Digite um código de campanha!', 'error');
                return;
            }
            
            const campaign = getCampaignByShareCode(shareCode);
            if (!campaign) {
                showNotification('Código de campanha inválido!', 'error');
                return;
            }
            
            showNotification(`Conectando à campanha: ${campaign.name}`, 'warning');
        }
        
        // ==================== COMPARTILHAMENTO ====================
        function showShareModal(shareCode) {
            document.getElementById('shareCodeDisplay').value = shareCode;
            document.getElementById('campaignCodeInput').value = shareCode;
            document.getElementById('shareModal').style.display = 'flex';
        }
        
        function copyShareCode() {
            const codeInput = document.getElementById('shareCodeDisplay');
            codeInput.select();
            codeInput.setSelectionRange(0, 99999);
            
            try {
                navigator.clipboard.writeText(codeInput.value);
                showNotification('Código copiado para a área de transferência!');
            } catch (err) {
                document.execCommand('copy');
                showNotification('Código copiado!');
            }
        }
        
        // ==================== UTILITÁRIOS ====================
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add('show');
            
            if (type === 'error') {
                notification.classList.add('error');
            } else if (type === 'warning') {
                notification.classList.add('warning');
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function setupSelectionButtons() {
            // Corrige eventos de clique nos botões
            document.addEventListener('click', function(e) {
                // Delegação de eventos para botões dinâmicos
            });
        }
        
        function saveActiveGame() {
            const activeGameData = {
                gameType: gameType,
                characterId: currentCharacter.id,
                playerName: currentPlayerName,
                storyProgress: storyProgress,
                startedAt: new Date().toISOString()
            };
            
            localStorage.setItem(STORAGE_ACTIVE_GAME, JSON.stringify(activeGameData));
        }
        
        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            const playerItem = document.createElement('div');
            playerItem.className = 'player-item';
            playerItem.innerHTML = `
                <div class="player-avatar">${currentPlayerName.charAt(0).toUpperCase()}</div>
                <div class="player-info">
                    <h4>${currentPlayerName}</h4>
                    <p>${currentCharacter.name} - ${currentCharacter.race} ${currentCharacter.class} (Nível ${currentCharacter.level})</p>
                    <p><small>Vida: ${storyState.health} | Mana: ${storyState.mana} | Vigor: ${storyState.stamina}</small></p>
                </div>
            `;
            
            playersList.appendChild(playerItem);
        }
        
        // ==================== DADOS DE EXEMPLO ====================
        function initializeSampleData() {
            const characters = getCharacters();
            const campaigns = getCampaigns();
            
            if (characters.length === 0) {
                const sampleCharacters = [
                    {
                        id: '1',
                        name: 'Gandalf',
                        class: 'Mago',
                        race: 'Humano',
                        level: 15,
                        strength: 10,
                        dexterity: 12,
                        constitution: 14,
                        intelligence: 20,
                        wisdom: 18,
                        charisma: 16,
                        background: 'Um poderoso mago da ordem dos Istari, conhecido por sua sabedoria e poderes mágicos.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        stats: {
                            battles: 12,
                            victories: 10,
                            goldCollected: 2500,
                            questsCompleted: 8
                        }
                    },
                    {
                        id: '2',
                        name: 'Legolas',
                        class: 'Ladino',
                        race: 'Elfo',
                        level: 12,
                        strength: 14,
                        dexterity: 20,
                        constitution: 12,
                        intelligence: 14,
                        wisdom: 16,
                        charisma: 15,
                        background: 'Príncipe élfico, mestre arqueiro com sentidos aguçados e graça incomparável.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        stats: {
                            battles: 8,
                            victories: 8,
                            goldCollected: 1800,
                            questsCompleted: 6
                        }
                    },
                    {
                        id: '3',
                        name: 'Gimli',
                        class: 'Guerreiro',
                        race: 'Anão',
                        level: 13,
                        strength: 18,
                        dexterity: 10,
                        constitution: 18,
                        intelligence: 12,
                        wisdom: 14,
                        charisma: 13,
                        background: 'Orgulhoso guerreiro anão, especialista em combate com machado e resistência incomparável.',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        stats: {
                            battles: 15,
                            victories: 12,
                            goldCollected: 3200,
                            questsCompleted: 9
                        }
                    }
                ];
                
                localStorage.setItem(STORAGE_CHARACTERS, JSON.stringify(sampleCharacters));
                loadCharacters();
            }
            
            if (campaigns.length === 0) {
                const sampleCampaigns = [
                    {
                        id: '1',
                        name: 'A Maldição de Strahd',
                        type: 'Mistério Sobrenatural',
                        master: 'Eu',
                        maxPlayers: 4,
                        description: 'Uma campanha de terror gótico no reino sombrio de Baróvia.',
                        players: [],
                        status: 'Aguardando',
                        shareCode: 'RPG123',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    },
                    {
                        id: '2',
                        name: 'Reinos Esquecidos',
                        type: 'Fantasia Épica',
                        master: 'Sistema',
                        maxPlayers: 6,
                        description: 'Aventura épica pelos Reinos Esquecidos, enfrentando dragões e criaturas míticas.',
                        players: [],
                        status: 'Aguardando',
                        shareCode: 'FANT45',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    }
                ];
                
                localStorage.setItem(STORAGE_CAMPAIGNS, JSON.stringify(sampleCampaigns));
                loadCampaigns();
                updateJoinableCampaigns();
            }
        }
        
        // ==================== FUNÇÕES GLOBAIS ====================
        window.editCharacter = editCharacter;
        window.deleteCharacter = deleteCharacter;
        window.editCampaign = editCampaign;
        window.deleteCampaign = deleteCampaign;
        window.joinCampaign = joinCampaign;
        window.showShareModal = showShareModal;
        window.startGame = startGame;
        window.selectCharacterForGame = selectCharacterForGame;
        window.masterControlScene = masterControlScene;
        window.restartGame = restartGame;
        window.returnToLobby = returnToLobby;
        window.saveAdventureSummary = saveAdventureSummary;
    </script>
</body>
</html>